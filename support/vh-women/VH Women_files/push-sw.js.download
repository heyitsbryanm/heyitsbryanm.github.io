!function(){"use strict";importScripts("https://www.gstatic.com/firebasejs/5.5.2/firebase.js"),importScripts("https://www.gstatic.com/firebasejs/5.5.2/firebase-app.js"),importScripts("https://www.gstatic.com/firebasejs/5.5.2/firebase-messaging.js");const t="https://sdk.resu.io/Campaign",o=o=>{let e="";return e=t,e+o};var e={},n={},a={};const i=function(t,e){e=g,Promise.all([h("Res_Passport_Id"),h("Res_Profile_Id"),h("_tenantId")]).then((n=>{let a={...t,id:r||e,passportId:n[0]||"",profileID:n[1]||"",tenantId:n[2]||"",domainName:self.registration.scope,status:t.status_code},i={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)};console.log(i,e);const s=o("/webCampaignTracking");fetch(s,i).then((t=>t.json())).then((t=>{console.log(t)}))}))};var s,c="",l=[],d="false",r=null,f="",g=null,p=null;function u(t,o){return new Promise((function(e,n){try{let a=indexedDB.open("resuldata",1);a.onsuccess=function(){try{s=a.result;try{s.objectStoreNames.contains("Res_Data")||s.createObjectStore("Res_Data",{keyPath:"key"})}catch(t){}console.log("openRequest db",a,s);var i=s.transaction(["Res_Data"],"readwrite").objectStore("Res_Data").put({key:btoa(t),value:btoa(btoa(JSON.stringify(o)))});i.onsuccess=function(t){e("Added to database.")},i.onerror=function(t){n("error: "+t)}}catch(t){console.log("addIDB err:",t)}}}catch(t){console.log("addIDB err:",t)}}))}function h(t){return console.log("getIDB",t),new Promise((function(o,e){try{let n=indexedDB.open("resuldata",1);n.onsuccess=function(){try{s=n.result;try{s.objectStoreNames.contains("Res_Data")||s.createObjectStore("Res_Data",{keyPath:"key"})}catch(t){}console.log("openRequest db",n,s);var a=s.transaction(["Res_Data"]).objectStore("Res_Data").get(btoa(t));a.onsuccess=function(t){let n=a.result.value;try{n=JSON.parse(atob(atob(n))),o(n)}catch(t){e(t)}},a.onerror=function(t){e(t)}}catch(t){e(t)}}}catch(t){e(t)}}))}addEventListener("fetch",(t=>{t.waitUntil(void(t.clientId&&clients.get(t.clientId).then((t=>{t&&("true"==d&&(console.log('showInAppNotification == "true"'),console.log("representNotificationData",n),t.postMessage({msg:n}),self.clients.matchAll({includeUncontrolled:!0,type:"window"}).then((function(t){t&&t.length&&t[0].postMessage({msg:n})}))),f&&(console.log("pass_id: ",f),t.postMessage({pass_id:f})))}))))})),self.addEventListener("install",(function(t){self.skipWaiting()})),self.addEventListener("activate",(function(t){t.waitUntil(self.clients.claim())})),self.onnotificationclose=t=>{try{i({action:"dismiss",status_code:"3"},g)}catch(t){}},self.onnotificationclick=t=>{if(console.log("notification click",t),t.notification.close(),t.notification.data){const o=t.notification.data.representNotificationData;o&&(c=o.click_actions),"true"===t.notification.data.showInAppNotification&&(console.log("showInAppNotification ",t.notification.data.showInAppNotification),console.log("representNotificationData ",t.notification.data.representNotificationData),d=t.notification.data.showInAppNotification,n=t.notification.data.representNotificationData)}var o={};if(t.notification.data&&t.notification.data.FCM_MSG)return c=t.notification.data.FCM_MSG.notification.click_action,console.log("actions1"+c),c||(console.log("empty action 1: ",c),c=self.location.origin),clients.openWindow(c).then((t=>{})),!1;if(console.log("normal foreground "+c),console.log("event.action: "+t.action),l||(l=t.notification.actions),l&&l.length>0&&(l=t.notification.actions),t.notification.data&&"false"===t.notification.data.showInAppNotification&&(t.notification.data.actions&&(l=t.notification.data.actions),t.notification.data.representNotificationData)){const o=t.notification.data.representNotificationData.data,e=JSON.parse(o).actions;l=e}switch(Object.keys(a).includes("notificationClick")&&a.notificationClick(),console.log("event.action",t.action),t.action){case"":o={action:"opened",status_code:"2"},c||(console.log("empty action 2: ",c),c=self.location.origin),clients.openWindow(c).then((t=>{console.log(t)})),Object.keys(a).includes("notificationViewClick")&&a.notificationViewClick();break;case"later":console.log(t.action),console.log("button_actions",l);let i=l.filter((o=>o.action==t.action))[0];o={action:t.action,status_code:"4"},console.log("later clicked!",i,e,n),setTimeout((()=>{console.log("later function executed");Object.keys(e).length?m(e):(console.log("keys not found"),v(w))}),i.duration),Object.keys(a).includes("notificationLaterClick")&&a.notificationLaterClick();break;case"dismiss":console.log(t.action),o={action:t.action,status_code:"3"},Object.keys(a).includes("notificationDismissClick")&&a.notificationDismissClick();break;default:{console.log("event",t);let e=l.filter((o=>o.action==t.action))[0];console.log("button_actions",l,e),console.log("customObj",JSON.stringify(e));o={action:t.action,status_code:e.actionId};let n=e.actionUrl||"";console.log("!(!!url)",!n),n||(n=self.location.origin),console.log("url",n),clients.openWindow(n).then((function(t){}))}}i(o,g)},self.addEventListener("message",(t=>{let a=null;try{self.clients.matchAll({includeUncontrolled:!0,type:"window"}).then((function(o){console.log("event message",t,o),a=o,console.log("event message mainWindow",a)}))}catch(t){}if("event"in t.data){if("ping"==t.data.event)try{self.clients.matchAll({includeUncontrolled:!0,type:"window"}).then((function(t){t&&t.length&&t[0].postMessage({ping:"success"})}))}catch(t){}if("customEventTest"==t.data.event){const o={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t.data.payload||t.data.data)};console.log("customEventTest triggred"),fetch("https://sdklb13.resu.io/Campaign/customeventstest",o).then((t=>t.json())).then((t=>{}))}if("customEvent"==t.data.event)console.log("Custome event triggred",t.data),Promise.all([h("Res_Passport_Id"),h("Res_Profile_Id"),h("_tenantId"),h("deviceId")]).then((e=>{try{const n={...t.data.payload,passportId:e[0]||"",profileID:e[1]||"",tenantId:e[2]||"",deviceId:e[3]||""},a={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)};fetch(o("/CustomEvents"),a).then((t=>t.json())).then((t=>{}))}catch(t){}}));else if("userRegisterEvent"==t.data.event){const e={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t.data.payload)};console.log("userRegisterEvent triggred",JSON.stringify(t.data.payload)),fetch(o("/UserRegister"),e).then((t=>t.json())).then((t=>{console.log("pass_id",t),"success"!=t.data&&t.data&&(f=t.data,p=setInterval((()=>{try{self.clients.matchAll({includeUncontrolled:!0,type:"window"}).then((function(t){t&&t.length&&(t[0].postMessage({pass_id:f}),console.log("posted to client"))}))}catch(t){}}),2e3),setTimeout((()=>{clearInterval(p)}),2e4))}))}else if("userJourney"==t.data.event){const e={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t.data.payload)};console.log("userJourney triggred",t.data),fetch(o("/UserJourney"),e).then((t=>t.json())).then((t=>{}))}else if("customMsgEvent"==t.data.event)e=t,t.data,console.log("dataToRepresent",e),console.log(t.data.data),r=t.data.data.id,console.log(r),m(e);else if("dismissInapp"==t.data.event)console.log("dismissInapp tapped"),d="false",n={};else if("notificationqueue"==t.data.event)console.log("notificationqueue",t.data.payload.data),v(t.data.payload);else if("checkSession"==t.data.event)self.registration.showNotification("session closed!");else if("clear_pass_id"==t.data.event)f="",clearInterval(p);else if("dismiss_TBN"==t.data.event){console.log("received event"),console.log("mainWindow",a),console.log("mClients",self.clients);new BroadcastChannel("sw-messages").postMessage({title:"Hello from SW"}),self.clients.matchAll({includeUncontrolled:!0,type:"window"}).then((function(t){console.log("iClients",t),t&&t.length&&(t[0].postMessage({event:"dismiss_TBN_tapped"}),a[0].postMessage({event:"dismiss_TBN_tapped"}))}))}}}));const m=t=>{console.log("representing"),console.log(t);const o=t.data.data.title;let e={body:t.data.data.body,...JSON.parse(t.data.data.options)};g=t.data.data.id,console.log(JSON.parse(t.data.data.options).url),console.log(e),l=e.actions,c="click_actions"in t.data.data?t.data.data.click_actions:t.data.data.click_action,console.log("click_actions: "+c);const n=t.data.data.ttl;console.log(n),function(t,o,e,n,a){console.log(e),console.log("validating notification...!");const s=new Date((new Date).toUTCString()).toISOString().split(".")[0];if(e&&new Date(s)>=new Date(e)){console.log("Notification Expired")}else{!function(t,o,e,n){o.tag=n,o.data=o,o.showInAppNotification="false",console.log("presentNotification called",t,o),self.registration.showNotification(t,o)}(t,o,0,n),i({action:"received",status_code:"5"},n),console.log("Notification presented")}}(o,e,n,g)};firebase.initializeApp({messagingSenderId:"537523308807"});var y=firebase.messaging(),w=null;function v(t){if(console.log("showBgNotification",t),t.data.resul&&(t.data=JSON.parse(atob(t.data.resul.substring(4))),t.data.resul&&(t.data=JSON.parse(atob(t.data.resul.substring(4)))),t.data.options=JSON.stringify(t.data.options)),t.data&&t.data.ttl&&"0001-01-01T00:00:00"==t.data.ttl&&(t.data.ttl=""),t.data&&t.data.ttl){const e=t.data.ttl,n=new Date((new Date).toUTCString()).toISOString().split(".")[0];if(new Date(n)>=new Date(e)){console.log("notification expired!",t);var o={action:"expired",status_code:"1"};return new Promise((function(t,o){}))}}console.log("payload.data.options",t.data.options);const e=JSON.parse(t.data.options);e.tag=t.data.id,console.log("notificationOptions",e),"image"==e.type&&(e.image=e.url),l=e.actions;const n=t.data.title;e.data={showInAppNotification:t.data.inAppNotification,representNotificationData:t.data},console.log("notificationOptions",e);o={action:"received",status_code:"5"};return g=t.data.id,i(o,t.data.id),self.registration.showNotification(n,e)}y.setBackgroundMessageHandler((function(t){return w=t,console.log("received bg",JSON.stringify(w)),console.log("BG payload",t),function(t){try{h("ResNotification").then((o=>{console.log("ResNotification",o),o.length>14?(o.shift(),o.push(t)):o.push(t),u("ResNotification",o)}),(o=>{u("ResNotification",[t])}))}catch(t){console.log("storeNotifications err",t)}}(t),"data"in t?v(w):new Promise((function(t,o){}))}))}();